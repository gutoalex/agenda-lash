<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda da Le - Ls C√≠lios</title>
    
    <!-- Depend√™ncias -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #fdf2f8; margin: 0; padding: 0; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input[type="date"] {
            -webkit-appearance: none;
            display: block;
            width: 100%;
            height: 50px;
            padding: 10px;
            background: white !important;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 16px;
        }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #db2777; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toggle-checkbox:checked { right: 0; border-color: #db2777; }
        .toggle-checkbox:checked + .toggle-label { background-color: #db2777; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modal Gradiente */
        .modal-gradient { background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%); }
    </style>
</head>
<body>

    <div id="root">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: #db2777; background-color: #fdf2f8;">
            <img src="img/logo.png" style="width: 150px; margin-bottom: 20px;" alt="Logo Ls C√≠lios" onerror="this.style.display='none'"/>
            <h2 style="font-family: sans-serif;">Carregando App...</h2>
            <div class="loader" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script type="text/babel">

        const { useState, useEffect, useRef } = React;

        // --- 1. CONFIGURA√á√ïES E CHAVES (PROTEGIDAS) ---
        const k1 = "AIzaSyC6-j5wwV";
        const k2 = "-2UcrtTr7Z5jM7Pp4cy78jmqA";
        const apiKey = k1 + k2; 

        const CONFIG = {
            nomeProfissional: "Le",
            telefoneProfissional: "5511989224362", 
            emailProfissional: "lscilios.contato@gmail.com", 
            senhaAdmin: "1234",
            scriptGoogleUrl: "https://script.google.com/macros/s/AKfycbz64IT565CxQvlkOds-gqlnX-gJOIKZuWozhrrxkPmCcRQ8SNLRge_m6QPmGyaC3tF-QQ/exec", 
            icalUrlPrivate: "https://calendar.google.com/calendar/ical/lscilios.contato%40gmail.com/private-994f64be13e6b1d832cf279c97c36175/basic.ics",
            icalUrlPublic: "https://calendar.google.com/calendar/ical/lscilios.contato%40gmail.com/public/basic.ics",
            
            depoimentos: [
                { nome: "Cliente", texto: "Amo sua flexibilidade, paci√™ncia e atendimento. Voc√™ me d√° a liberdade de escolher o estilo e a durabilidade √© √≥tima!" },
                { nome: "Cliente", texto: "Seu trabalho √© √≥timo! O espa√ßo aconchegante. Higiene impec√°vel e cuidado para n√£o arder os olhos." },
                { nome: "Cliente", texto: "Seu trabalho √© sinceramente o melhor que j√° fiz. N√£o fico mais sem c√≠lios e sem voc√™!" }
            ],

            sobrancelha: { id: 999, nome: "Design de Sobrancelhas", preco: 35, duracao: 0.5 },

            servicos: [
                { id: 1, nome: "Volume Pamela", desc: "Fio a Fio Black. Leve e natural.", imagem: "img/pamela.jpg", duracao: 2, precos: { aplicacao: 115, manutencao: 95, remocao: 30 } },
                { id: 2, nome: "Volume Paty", desc: "Brasileiro. Fios em Y.", imagem: "img/paty.jpg", duracao: 2.5, precos: { aplicacao: 135, manutencao: 100, remocao: 30 } },
                { id: 3, nome: "Volume Jaque", desc: "Fox Eyes. Olhar sensual.", imagem: "img/jaque.jpg", duracao: 2.5, precos: { aplicacao: 135, manutencao: 100, remocao: 30 } },
                { id: 4, nome: "Volume Emily", desc: "Efeito Delineado. Curvatura M.", imagem: "img/emily.jpg", duracao: 2.5, precos: { aplicacao: 140, manutencao: 105, remocao: 30 } },
                { id: 5, nome: "Volume Duda", desc: "Volume 3D. Fios ultrafinos.", imagem: "img/duda.jpg", duracao: 3, precos: { aplicacao: 140, manutencao: 105, remocao: 30 } },
                { id: 6, nome: "Volume Carol", desc: "Ingl√™s 5D. Volumoso.", imagem: "img/carol.jpg", duracao: 3, precos: { aplicacao: 155, manutencao: 105, remocao: 30 } },
                { id: 7, nome: "Volume Nath", desc: "Efeito Molhado. Elegante.", imagem: "img/nath.jpg", duracao: 2.5, precos: { aplicacao: 130, manutencao: 100, remocao: 30 } },
                { id: 8, nome: "Volume Grazi", desc: "Naturalmente marcante.", imagem: "img/grazi.jpg", duracao: 2, precos: { aplicacao: 135, manutencao: 105, remocao: 30 } },
                { id: 9, nome: "Volume Bia", desc: "Volume Sirena. Puxadinho.", imagem: "img/bia.jpg", duracao: 2.5, precos: { aplicacao: 130, manutencao: 100, remocao: 30 } },
                { id: 10, nome: "Volume Fernanda", desc: "Delicado e elegante. 3 fios.", imagem: "img/fernanda.jpg", duracao: 2, precos: { aplicacao: 135, manutencao: 105, remocao: 30 } }
            ]
        };

        // --- 2. √çCONES ---
        const Icons = {
            Whatsapp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            Gemini: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-pink-500"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none" className="text-yellow-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
            Robot: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>,
            Gift: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-pink-500"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>,
            Analysis: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h5"></path><path d="M17 12h5"></path><path d="M12 2v5"></path><path d="M12 17v5"></path><circle cx="12" cy="12" r="4"></circle><path d="M10 2 2.5 9.5"></path><path d="M14 2l7.5 7.5"></path><path d="M10 22l-7.5-7.5"></path><path d="M14 22l7.5-7.5"></path></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-pink-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
            CreditCard: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>,
            Smartphone: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>,
            Dollar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            CloudDownload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Cake: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"></path><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"></path><path d="M2 21h20"></path><path d="M7 8v2"></path><path d="M12 8v2"></path><path d="M17 8v2"></path><path d="M7 4h.01"></path><path d="M12 4h.01"></path><path d="M17 4h.01"></path></svg>
        };

        // --- 3. FUN√á√ïES GLOBAIS ---
        
        const formatarTelefone = (value) => {
            if(!value) return "";
            const numero = value.replace(/\D/g, "");
            if (numero.length <= 10) {
                return numero.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else {
                return numero.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, "($1) $2-$3");
            }
        };

        const validarEmail = (email) => {
            if (!email) return true; 
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        };

        const salvarAgendamentoPlanilha = async (dadosCliente) => {
            if (!CONFIG.scriptGoogleUrl) return; 
            try {
                let nomeServico = dadosCliente.servicoObj ? dadosCliente.servicoObj.nome : "Servi√ßo Avulso";
                
                if (dadosCliente.incluiSobrancelha && dadosCliente.servicoObj && dadosCliente.servicoObj.id !== 999) {
                    nomeServico += " + Design Sobrancelhas";
                }

                const payload = {
                    nome: dadosCliente.nome || "",
                    whatsapp: dadosCliente.whatsapp || "",
                    email: dadosCliente.email || "",
                    nascimento: dadosCliente.nascimento || "",
                    servico: nomeServico,
                    duracao: dadosCliente.duracaoTotal || 2,
                    tipoServico: dadosCliente.tipoServico || "Aplica√ß√£o",
                    precoFinal: dadosCliente.precoFinal || 0,
                    data: dadosCliente.data || "",
                    hora: dadosCliente.hora || "",
                    tipoAtendimento: dadosCliente.tipoAtendimento || "studio",
                    endereco: dadosCliente.endereco || ""
                };

                await fetch(CONFIG.scriptGoogleUrl, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (e) { 
                console.error("Erro ao salvar:", e);
                return false;
            }
        };

        const parseIcsDate = (val) => {
            if (!val) return null;
            const clean = val.replace(/[^0-9TZ]/g, '');
            const y = parseInt(clean.substring(0, 4));
            const m = parseInt(clean.substring(4, 6)) - 1;
            const d = parseInt(clean.substring(6, 8));
            if (!clean.includes('T')) return { isAllDay: true, date: new Date(y, m, d, 0, 0, 0) };
            const time = clean.split('T')[1];
            const h = parseInt(time.substring(0, 2));
            const min = parseInt(time.substring(2, 4));
            let date = new Date(y, m, d, h, min, 0);
            if (val.includes('Z')) date.setHours(date.getHours() - 3);
            return { isAllDay: false, date: date };
        };

        const fetchRawEvents = async (url, dateStr) => {
            try {
                // Usando proxy mais robusto e est√°vel
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                if (!response.ok) return [];
                
                const data = await response.json();
                const icsText = data.contents;
                
                const events = [];
                const lines = icsText.split(/\r\n|\n|\r/);
                let currentEvent = null;
                let inEvent = false;
                
                lines.forEach(line => {
                    if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; currentEvent = {}; } 
                    else if (line.startsWith('END:VEVENT')) { 
                        if (currentEvent && currentEvent.dtstart) events.push(currentEvent); 
                        inEvent = false;
                        currentEvent = null; 
                    } 
                    else if (inEvent && currentEvent) {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > -1) {
                            const keyPart = line.substring(0, colonIndex).split(';')[0];
                            const value = line.substring(colonIndex + 1);
                            if (keyPart === 'SUMMARY') currentEvent.summary = value;
                            if (keyPart === 'LOCATION') currentEvent.location = value;
                            if (keyPart.startsWith('DTSTART')) currentEvent.dtstart = value;
                            if (keyPart.startsWith('DTEND')) currentEvent.dtend = value;
                            if (keyPart === 'DESCRIPTION') currentEvent.description = value;
                        }
                    }
                });
                
                if (dateStr) {
                    const [tYear, tMonth, tDay] = dateStr.split('-').map(Number);
                    return events.filter(ev => {
                        const startInfo = parseIcsDate(ev.dtstart);
                        if (!startInfo) return false;
                        const d = startInfo.date;
                        return d.getFullYear() === tYear && d.getMonth() === tMonth - 1 && d.getDate() === tDay;
                    }).map(ev => {
                        const startInfo = parseIcsDate(ev.dtstart);
                        ev.localHour = startInfo ? startInfo.date.getHours() : -1;
                        return ev;
                    });
                }
                return events;
            } catch (e) {
                console.error("Erro ao buscar eventos raw", e);
                return [];
            }
        };

        const fetchICSAndParse = async (url, dateStr, horariosDoDia = []) => {
            try {
                // Usando o mesmo proxy est√°vel
                const proxyUrl = 'https://api.allorigins.win/get?url='; 
                const targetUrl = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                if (!response.ok) return [];
                const data = await response.json();
                const icsText = data.contents;
                
                const ocupados = [];
                const lines = icsText.split(/\r\n|\n|\r/);
                let inEvent = false;
                let dtStart = "";
                let dtEnd = "";
                
                const [tYear, tMonth, tDay] = dateStr.split('-').map(Number);
                const targetDateStart = new Date(tYear, tMonth - 1, tDay, 0, 0, 0);
                const targetDateEnd = new Date(tYear, tMonth - 1, tDay, 23, 59, 59);

                lines.forEach(line => {
                    if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; dtStart = ""; dtEnd = ""; }
                    if (line.startsWith('END:VEVENT')) { 
                        inEvent = false;
                        if (dtStart) {
                            const startInfo = parseIcsDate(dtStart);
                            if (startInfo) {
                                let startDate = startInfo.date;
                                let endDate = null;

                                if (dtEnd) {
                                    const endInfo = parseIcsDate(dtEnd);
                                    if (endInfo) endDate = endInfo.date;
                                }

                                if (!endDate) {
                                    endDate = new Date(startDate);
                                    endDate.setHours(endDate.getHours() + 1);
                                }

                                if (startInfo.isAllDay) {
                                     if (startDate.getFullYear() === tYear && startDate.getMonth() === tMonth - 1 && startDate.getDate() === tDay) {
                                        horariosDoDia.forEach(h => { if(!ocupados.includes(h)) ocupados.push(h); });
                                     }
                                } else {
                                    if (endDate > targetDateStart && startDate < targetDateEnd) {
                                        horariosDoDia.forEach(slot => {
                                            const [sh, sm] = slot.split(':').map(Number);
                                            const slotDate = new Date(tYear, tMonth - 1, tDay, sh, sm, 0);
                                            if (slotDate >= startDate && slotDate < endDate) {
                                                if (!ocupados.includes(slot)) ocupados.push(slot);
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    }
                    if (inEvent) {
                        if (line.startsWith('DTSTART')) dtStart = line.split(':')[1];
                        if (line.startsWith('DTEND')) dtEnd = line.split(':')[1];
                    }
                });
                return ocupados;
            } catch (e) { 
                console.error("Erro no processamento do ICS:", e);
                return []; 
            }
        };

        async function chamarGemini(prompt, systemInstruction = "") {
            if (!apiKey) return null;
            const fullPrompt = systemInstruction ? `Instru√ß√£o do Sistema: ${systemInstruction}\n\nUsu√°rio: ${prompt}` : prompt;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });
                if (!response.ok) return "Opa, a IA est√° tirando um cochilo.";
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { return "Erro de conex√£o."; }
        }

        // --- 4. COMPONENTES ---

        function ChatbotIA() {
            const [aberto, setAberto] = useState(false);
            const [msg, setMsg] = useState('');
            const [historico, setHistorico] = useState([{ role: 'bot', text: 'Ol√°! Sou a assistente virtual da Le. Tem alguma d√∫vida? üíñ' }]);
            const [loading, setLoading] = useState(false);
            const msgEndRef = useRef(null);
            useEffect(() => { msgEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [historico]);
            const enviarMsg = async () => {
                if (!msg.trim()) return;
                const novaMsg = { role: 'user', text: msg };
                setHistorico(prev => [...prev, novaMsg]);
                setMsg('');
                setLoading(true);
                const resposta = await chamarGemini(msg, "Voc√™ √© a assistente virtual da Ls C√≠lios. Responda curto e simp√°tica.");
                setHistorico(prev => [...prev, { role: 'bot', text: resposta || "Desculpe, n√£o entendi." }]);
                setLoading(false);
            };
            return (
                <React.Fragment>
                    <button onClick={() => setAberto(!aberto)} className="fixed bottom-4 left-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white p-3 rounded-full shadow-lg z-50 hover:scale-105 transition-transform flex items-center gap-2 font-bold text-xs">{aberto ? <Icons.Close /> : <span className="text-xl">ü§ñ</span>}{!aberto && "D√∫vidas?"}</button>
                    {aberto && (
                        <div className="fixed bottom-20 left-4 w-72 bg-white rounded-2xl shadow-2xl border border-gray-100 z-50 flex flex-col overflow-hidden animate-in fade-in slide-in-from-bottom-4" style={{maxHeight: '60vh'}}>
                            <div className="bg-purple-600 p-3 text-white flex justify-between items-center"><span className="font-bold text-sm flex items-center gap-2">ü§ñ Assistente Ls C√≠lios</span><button onClick={() => setAberto(false)}><Icons.Close /></button></div>
                            <div className="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3 text-xs">
                                {historico.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] p-2 rounded-xl ${m.role === 'user' ? 'bg-purple-100 text-purple-800 rounded-tr-none' : 'bg-white border border-gray-200 text-gray-600 rounded-tl-none'}`}>{m.text}</div></div>))}
                                <div ref={msgEndRef} />
                            </div>
                            <div className="p-2 bg-white border-t border-gray-100 flex gap-2">
                                <input type="text" className="flex-1 border border-gray-300 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-purple-500" placeholder="Digite..." value={msg} onChange={(e) => setMsg(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && enviarMsg()} />
                                <button onClick={enviarMsg} disabled={loading} className="bg-purple-600 text-white p-2 rounded-lg">‚û§</button>
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        }

        function TelaFinanceiro({ listaClientes, despesas, setDespesas }) {
            const [novaDespesa, setNovaDespesa] = useState({ nome: '', valor: '', tipo: 'fixa' });
            const salvarDespesa = () => {
                if(!novaDespesa.nome || !novaDespesa.valor) return;
                const updated = [...despesas, { ...novaDespesa, id: Date.now() }];
                setDespesas(updated);
                localStorage.setItem('ls_despesas', JSON.stringify(updated));
                setNovaDespesa({ nome: '', valor: '', tipo: 'fixa' });
            };
            const receitaTotal = listaClientes.reduce((acc) => acc + 120, 0); 
            const despesaTotal = despesas.reduce((acc, curr) => acc + parseFloat(curr.valor), 0);
            const lucro = receitaTotal - despesaTotal;
            return (
                <div className="p-4 flex-1 flex flex-col gap-4 fade-in overflow-y-auto">
                    <div className="grid grid-cols-3 gap-2">
                        <div className="bg-green-50 p-2 rounded-xl border border-green-100 text-center"><span className="text-[10px] uppercase font-bold text-green-400 block">Receita</span><span className="text-lg font-bold text-green-700">R${receitaTotal}</span></div>
                        <div className="bg-red-50 p-2 rounded-xl border border-red-100 text-center"><span className="text-[10px] uppercase font-bold text-red-400 block">Despesas</span><span className="text-lg font-bold text-red-700">R${despesaTotal}</span></div>
                        <div className="bg-blue-50 p-2 rounded-xl border border-blue-100 text-center"><span className="text-[10px] uppercase font-bold text-blue-400 block">Lucro</span><span className="text-lg font-bold text-blue-700">R${lucro}</span></div>
                    </div>
                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 className="font-bold text-gray-700 mb-3 text-sm flex gap-2"><Icons.Chart /> Nova Despesa</h3>
                        <div className="flex gap-2 mb-2">
                            <input type="text" placeholder="Ex: Luz" className="flex-1 p-2 rounded-lg border text-sm" value={novaDespesa.nome} onChange={e => setNovaDespesa({...novaDespesa, nome: e.target.value})} />
                            <input type="number" placeholder="R$" className="w-20 p-2 rounded-lg border text-sm" value={novaDespesa.valor} onChange={e => setNovaDespesa({...novaDespesa, valor: e.target.value})} />
                        </div>
                        <button onClick={salvarDespesa} className="w-full bg-red-500 text-white rounded-lg text-sm font-bold hover:bg-red-600 py-2">Adicionar</button>
                        <div className="mt-3 space-y-1">{despesas.slice(-3).map(d => (<div key={d.id} className="flex justify-between text-xs text-gray-500 border-b border-gray-200 pb-1"><span>{d.nome}</span><span>- R${d.valor}</span></div>))}</div>
                    </div>
                </div>
            );
        }

        function TelaEstrategiaIA({ listaClientes, despesas }) {
            const [analiseGeral, setAnaliseGeral] = useState("");
            const [loadingGeral, setLoadingGeral] = useState(false);
            const [pergunta, setPergunta] = useState("");
            const [respostaChat, setRespostaChat] = useState("");
            const [loadingChat, setLoadingChat] = useState(false);
            const gerarAnaliseFinanceira = async () => {
                setLoadingGeral(true);
                const resp = await chamarGemini(`Analise: Receita R$${listaClientes.length * 120}, Despesas R$${despesas.reduce((a,b)=>a+parseFloat(b.valor),0)}. D√™ 2 dicas de lucro.`);
                setAnaliseGeral(resp);
                setLoadingGeral(false);
            };
            const perguntarConselheira = async () => {
                if(!pergunta) return;
                setLoadingChat(true);
                const prompt = `Sou Lash Designer. Pergunta: "${pergunta}". Responda curto.`;
                const resposta = await chamarGemini(prompt, "Conselheira de neg√≥cios.");
                setRespostaChat(resposta || "Erro.");
                setLoadingChat(false);
            };
            return (
                <div className="p-4 flex-1 flex flex-col gap-4 fade-in overflow-y-auto">
                    <div className="bg-gradient-to-r from-purple-600 to-pink-500 p-4 rounded-xl text-white shadow-md">
                        <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Sparkles /> Intelig√™ncia Financeira</h3>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <h4 className="font-bold text-gray-700 text-sm mb-2">üìä An√°lise de Faturamento</h4>
                        {!analiseGeral ? (
                            <button onClick={gerarAnaliseFinanceira} disabled={loadingGeral} className="w-full bg-purple-100 text-purple-700 font-bold py-3 rounded-xl hover:bg-purple-200 transition-all flex items-center justify-center gap-2">Gerar Relat√≥rio ‚ú®</button>
                        ) : (
                            <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100 whitespace-pre-wrap">{analiseGeral}<button onClick={() => setAnaliseGeral("")} className="block mt-2 text-xs text-purple-500 font-bold underline">Nova An√°lise</button></div>
                        )}
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex-1 flex flex-col">
                        <h4 className="font-bold text-gray-700 text-sm mb-2 flex items-center gap-2"><Icons.Robot /> Conselheira do Studio</h4>
                        <div className="flex-1 bg-gray-50 p-2 rounded mb-2 text-xs overflow-y-auto max-h-40">{respostaChat || "Pergunte algo..."}</div>
                        <div className="flex gap-2"><input type="text" className="flex-1 border rounded px-2 py-1 text-sm" value={pergunta} onChange={e=>setPergunta(e.target.value)}/><button onClick={perguntarConselheira} disabled={loadingChat} className="bg-pink-500 text-white p-2 rounded">‚û§</button></div>
                    </div>
                </div>
            );
        }

        function TelaCliente({ aoFinalizar }) {
            const [step, setStep] = useState(0); 
            const [dados, setDados] = useState({ 
                nome: '', whatsapp: '', email: '', nascimento: '', 
                servicoObj: null, tipoServico: '', precoFinal: 0, 
                incluiSobrancelha: false, duracaoTotal: 0,
                data: '', hora: '', tipoAtendimento: 'studio', endereco: '', complemento: '' 
            });
            const [horariosDisponiveis, setHorariosDisponiveis] = useState([]);
            const [horariosOcupados, setHorariosOcupados] = useState([]);
            const [carregandoHorarios, setCarregandoHorarios] = useState(false);
            const [servicoExpandido, setServicoExpandido] = useState(null);
            const [modalDetalhes, setModalDetalhes] = useState(null); 
            const [showModalIA, setShowModalIA] = useState(false);
            const [inputIA, setInputIA] = useState('');
            const [loadingIA, setLoadingIA] = useState(false);
            const [respostaIA, setRespostaIA] = useState(null);
            const [depoimentoIndex, setDepoimentoIndex] = useState(0);
            const [modalConfirmacao, setModalConfirmacao] = useState(false);
            const [horarioPendente, setHorarioPendente] = useState('');
            const [loadingSalvar, setLoadingSalvar] = useState(false);
            const [horariosDoDia, setHorariosDoDia] = useState([]);

            const hoje = new Date().toISOString().split('T')[0];

            useEffect(() => { const interval = setInterval(() => { setDepoimentoIndex((prev) => (prev + 1) % CONFIG.depoimentos.length); }, 5000); return () => clearInterval(interval); }, []);

            const gerarHorarios = (dateStr) => {
                if (!dateStr) return [];
                const dia = new Date(dateStr + 'T12:00:00').getDay();
                if (dia === 0 || dia === 1) return []; 
                const lista = [];
                const inicio = dia === 2 || dia === 4 ? 9 : 10;
                const fim = dia === 6 ? 14 : 18;
                for (let h = inicio; h <= fim; h++) lista.push((h < 10 ? '0'+h : h) + ":00");
                return lista;
            };

            // Fun√ß√£o definida dentro do escopo do componente
            const verificarAgenda = async (data) => {
                setCarregandoHorarios(true);
                const slots = gerarHorarios(data);
                setHorariosDoDia(slots);
                
                if (slots.length > 0) {
                    const ocupados = await fetchICSAndParse(CONFIG.icalUrlPublic, data, slots);
                    setHorariosOcupados(ocupados);
                    setHorariosDisponiveis(slots);
                } else {
                    setHorariosOcupados([]);
                    setHorariosDisponiveis([]);
                }
                setCarregandoHorarios(false);
            };

            // Hook para chamar a verifica√ß√£o quando a data mudar
            useEffect(() => { 
                if (dados.data) { 
                    verificarAgenda(dados.data); 
                } 
            }, [dados.data]);

            const selecionarCategoria = (tipo) => {
                if (tipo === 'cilios') { setDados({...dados, incluiSobrancelha: false}); setStep(1); } 
                else if (tipo === 'sobrancelha') {
                    const s = {...CONFIG.sobrancelha, precos: { aplicacao: CONFIG.sobrancelha.preco, manutencao: CONFIG.sobrancelha.preco }};
                    setDados({...dados, servicoObj: s, tipoServico: 'aplicacao', precoFinal: s.preco, incluiSobrancelha: false, duracaoTotal: s.duracao});
                    setStep(2); 
                } 
                else if (tipo === 'combo') { setDados({...dados, incluiSobrancelha: true}); setStep(1); }
            };

            const toggleCombo = () => {
                setDados(prev => ({ ...prev, incluiSobrancelha: !prev.incluiSobrancelha }));
            };

            const selecionarServico = (servico, tipo) => {
                let preco = servico.precos[tipo];
                let duracao = servico.duracao;
                let isCombo = dados.incluiSobrancelha;
                if (servico.id === 999) { isCombo = false; }
                else if (isCombo) { preco += CONFIG.sobrancelha.preco; duracao += CONFIG.sobrancelha.duracao; }
                setDados({ ...dados, servicoObj: servico, tipoServico: tipo, precoFinal: preco, duracaoTotal: duracao, incluiSobrancelha: isCombo });
                setModalDetalhes(null);
                setStep(2);
            };

            const selecionarHorario = (h) => {
                setHorarioPendente(h);
                setModalConfirmacao(true);
            };

            const confirmarHorario = () => {
                setDados({ ...dados, hora: horarioPendente });
                setModalConfirmacao(false);
            };
            
            const handlePhoneChange = (e) => {
                const formatted = formatarTelefone(e.target.value);
                setDados({ ...dados, whatsapp: formatted });
            };

            const salvarEAvancar = async () => {
                if (!dados.nome || !dados.whatsapp || !dados.data || !dados.hora) { alert("Preencha todos os campos obrigat√≥rios!"); return; }
                if (dados.whatsapp.length < 14) { alert("WhatsApp inv√°lido!"); return; }
                if (!validarEmail(dados.email)) { alert("Digite um e-mail v√°lido."); return; }
                if (!dados.servicoObj) { alert("Erro: Servi√ßo n√£o selecionado."); return; }
                
                if (dados.tipoAtendimento === 'domicilio' && (!dados.endereco || dados.endereco.trim().length < 10)) { 
                    alert("Endere√ßo muito curto. Por favor, preencha o endere√ßo completo."); 
                    return; 
                }

                setLoadingSalvar(true);
                await salvarAgendamentoPlanilha(dados);
                setLoadingSalvar(false);
                aoFinalizar(dados);
            };

            const consultarEstiloIA = async () => {
                if (!inputIA.trim()) return;
                setLoadingIA(true);
                setRespostaIA(null);
                const resp = await chamarGemini(inputIA, "Recomende um estilo de c√≠lios do cat√°logo da Ls C√≠lios.");
                setRespostaIA({ motivo: resp || "Recomendo o Volume Brasileiro, √© super vers√°til!" });
                setLoadingIA(false);
            };

            return (
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-pink-100 relative min-h-[500px]">
                    <div className="bg-pink-50 h-2 w-full flex"><div className={`h-full bg-pink-500 transition-all duration-300 ${step > 0 ? 'w-full' : 'w-1/3'}`}></div></div>
                    <div className="p-6">
                        {step === 0 && (
                            <div className="fade-in text-center py-4 space-y-3">
                                <h2 className="text-xl font-bold text-gray-800 mb-2">Ol√°, maravilhosa! ‚ú®</h2>
                                <p className="text-gray-500 text-sm mb-6">O que vamos real√ßar hoje?</p>
                                <button onClick={() => selecionarCategoria('cilios')} className="w-full bg-white border border-pink-200 p-4 rounded-xl flex items-center justify-between hover:bg-pink-50 card-hover transition-all"><div className="flex items-center gap-3"><span className="text-2xl">üëÅÔ∏è</span><div className="text-left"><span className="block font-bold text-gray-700">C√≠lios</span><span className="text-xs text-gray-400">Extens√£o, Manuten√ß√£o...</span></div></div><span className="text-pink-300">‚ûú</span></button>
                                <button onClick={() => selecionarCategoria('sobrancelha')} className="w-full bg-white border border-purple-200 p-4 rounded-xl flex items-center justify-between hover:bg-purple-50 card-hover transition-all"><div className="flex items-center gap-3"><span className="text-2xl">‚úèÔ∏è</span><div className="text-left"><span className="block font-bold text-gray-700">Sobrancelhas</span><span className="text-xs text-gray-400">Design Simples (30min)</span></div></div><span className="text-purple-300">‚ûú</span></button>
                                <button onClick={() => selecionarCategoria('combo')} className="w-full bg-gradient-to-r from-pink-500 to-purple-600 p-4 rounded-xl flex items-center justify-between text-white shadow-lg card-hover transition-all relative overflow-hidden"><div className="absolute top-0 right-0 bg-yellow-400 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg">MAIS PEDIDO üî•</div><div className="flex items-center gap-3"><span className="text-2xl bg-white/20 p-1 rounded-full">üíñ</span><div className="text-left"><span className="block font-bold">COMBO COMPLETO</span><span className="text-xs text-white/90">C√≠lios + Sobrancelha</span></div></div><span className="text-xl">‚ûú</span></button>
                            </div>
                        )}
                        {step === 1 && (
                            <div className="fade-in space-y-4">
                                <button onClick={() => setStep(0)} className="text-xs text-gray-400 mb-2 hover:text-pink-500 flex items-center gap-1">‚Üê Voltar</button>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">Escolha o Modelo</h2>
                                    <button onClick={() => setShowModalIA(true)} className="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold flex items-center gap-1 hover:bg-purple-200 transition-colors sparkle-icon"><Icons.Gemini /> Me ajude</button>
                                </div>
                                <div className="mb-4 p-3 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border border-pink-100 flex items-center justify-between shadow-sm">
                                    <div className="flex items-center gap-2"><span className="text-xl">‚ú®</span><div><p className="text-sm font-bold text-gray-800">Adicionar Sobrancelha?</p><p className="text-xs text-gray-500">+ Design Simples (+R$35)</p></div></div>
                                    <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked={dados.incluiSobrancelha} onChange={toggleCombo}/><label className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${dados.incluiSobrancelha ? 'bg-pink-500' : 'bg-gray-300'}`}></label></div>
                                </div>
                                <div className="space-y-4">{CONFIG.servicos.map((s) => !s.isSobrancelha && (
                                    <div key={s.id} className="border border-pink-100 rounded-xl overflow-hidden bg-white shadow-sm hover:shadow-md transition-all">
                                        <div onClick={() => setServicoExpandido(servicoExpandido === s.id ? null : s.id)} className="w-full text-left p-4 flex gap-4 items-center bg-gray-50 hover:bg-pink-50 transition-colors relative cursor-pointer">
                                            <div className="w-16 h-16 shrink-0 bg-white rounded-lg border border-pink-100 overflow-hidden relative group"><img src={s.imagem} alt={s.nome} className="w-full h-full object-cover" onError={(e) => { e.target.style.display = 'none'; }} /><div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" onClick={(e) => { e.stopPropagation(); setModalDetalhes(s); }}><Icons.Info className="text-white"/></div></div>
                                            <div className="flex-1"><div className="flex justify-between items-start"><span className="font-bold text-gray-700 block">{s.nome}</span><button onClick={(e) => { e.stopPropagation(); setModalDetalhes(s); }} className="text-pink-400 hover:text-pink-600 text-xs px-2 py-1 rounded bg-pink-50"><Icons.Info /></button></div><span className="text-[10px] text-gray-500 line-clamp-2 mt-1">{s.desc}</span></div>
                                            <div className="text-pink-400 pl-2">{servicoExpandido === s.id ? '‚ñº' : '‚ñ∂'}</div>
                                        </div>
                                        {servicoExpandido === s.id && (<div className="p-3 bg-white grid gap-2 animate-in fade-in slide-in-from-top-2 border-t border-pink-50"><button onClick={() => selecionarServico(s, 'aplicacao')} className="w-full text-left p-3 rounded-lg border border-gray-100 hover:border-pink-300 hover:bg-pink-50 flex justify-between items-center group"><span className="text-sm font-medium text-gray-600 group-hover:text-pink-600">‚ú® Aplica√ß√£o Nova</span><span className="font-bold text-pink-500">R$ {s.precos.aplicacao + (dados.incluiSobrancelha ? 35 : 0)}</span></button><button onClick={() => selecionarServico(s, 'manutencao')} className="w-full text-left p-3 rounded-lg border border-gray-100 hover:border-purple-300 hover:bg-purple-50 flex justify-between items-center group"><span className="text-sm font-medium text-gray-600 group-hover:text-purple-600">üîß Manuten√ß√£o</span><span className="font-bold text-purple-500">R$ {s.precos.manutencao + (dados.incluiSobrancelha ? 35 : 0)}</span></button><button onClick={() => selecionarServico(s, 'remocao')} className="w-full text-left p-3 rounded-lg border hover:bg-red-50 flex justify-between items-center group"><span className="text-sm font-medium text-gray-600 group-hover:text-red-600">üßº Remo√ß√£o</span><span className="font-bold text-red-400">R$ {s.precos.remocao + (dados.incluiSobrancelha ? 35 : 0)}</span></button></div>)}
                                    </div>
                                ))}</div>
                            </div>
                        )}
                        {step === 2 && (
                            <div className="fade-in space-y-3">
                                <button onClick={() => setStep(1)} className="text-xs text-gray-400">‚Üê Voltar</button>
                                <div className="bg-pink-50 p-3 rounded-lg text-center border border-pink-100">
                                    <p className="font-bold text-pink-600 text-sm">{dados.servicoObj.nome} {dados.incluiSobrancelha && !dados.servicoObj.nome.includes("Sobrancelhas") ? "+ Sobrancelha" : ""}</p>
                                    <p className="text-xs text-gray-600 uppercase">{dados.tipoServico} - R$ {dados.precoFinal}</p>
                                </div>
                                <div className="mb-4 bg-white border border-gray-100 rounded-xl p-3 shadow-sm">
                                    <h3 className="text-xs font-bold text-gray-500 mb-2 uppercase flex items-center gap-1">Antes de vir:</h3>
                                    <div className="grid grid-cols-2 gap-2 text-[10px] text-gray-600">
                                        <div className="flex items-center gap-1"><Icons.Clock /><span>Dura√ß√£o: {dados.duracaoTotal}h</span></div>
                                        <div className="flex items-center gap-1"><Icons.EyeOff /><span>Sem R√≠mel</span></div>
                                        <div className="flex items-center gap-1"><span>üëì</span><span>Remover Lentes</span></div>
                                        <div className="flex items-center gap-1"><span>‚è∞</span><span>Toler√¢ncia 15min</span></div>
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-gray-100 text-[9px] text-red-400 leading-tight">‚ö†Ô∏è <strong>Contraindica√ß√µes:</strong> Alergias, doen√ßas oculares ativas (conjuntivite) ou pele extremamente sens√≠vel.</div>
                                </div>
                                <input type="text" className="w-full p-3 border rounded-xl text-sm" placeholder="Seu Nome *" value={dados.nome} onChange={e => setDados({...dados, nome: e.target.value})} />
                                <input type="tel" className="w-full p-3 border rounded-xl text-sm" placeholder="WhatsApp (DDD) *" value={dados.whatsapp} onChange={handlePhoneChange} maxLength="15" />
                                <div className="flex gap-2">
                                    <input type="email" className="flex-1 p-3 bg-white rounded-xl border border-gray-200 text-sm text-gray-900 placeholder-gray-400" placeholder="E-mail" value={dados.email} onChange={(e) => setDados({...dados, email: e.target.value})} />
                                    <div className="w-2/5 relative">
                                        <input type="date" className="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm text-gray-900" value={dados.nascimento} onChange={(e) => setDados({...dados, nascimento: e.target.value})} />
                                    </div>
                                </div>
                                <div className="p-3 bg-gray-50 rounded-xl border border-gray-200">
                                    <label className="block text-xs font-bold text-gray-500 mb-2">ONDE SER√Å O ATENDIMENTO?</label>
                                    <div className="flex gap-2 mb-3">
                                        <button onClick={() => setDados({...dados, tipoAtendimento: 'studio'})} className={`flex-1 py-2 text-xs rounded-lg border font-bold ${dados.tipoAtendimento === 'studio' ? 'bg-pink-500 text-white' : 'bg-white'}`}>No Studio</button>
                                        <button onClick={() => setDados({...dados, tipoAtendimento: 'domicilio'})} className={`flex-1 py-2 text-xs rounded-lg border font-bold ${dados.tipoAtendimento === 'domicilio' ? 'bg-pink-500 text-white' : 'bg-white'}`}>A Domic√≠lio</button>
                                    </div>
                                    {dados.tipoAtendimento === 'domicilio' && (
                                        <div className="fade-in space-y-2">
                                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-[10px] text-yellow-800 mb-2">‚ö†Ô∏è Taxa de Uber ser√° cobrada.</div>
                                            <input type="text" className="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm text-gray-900 placeholder-gray-400" placeholder="Endere√ßo Completo *" value={dados.endereco} onChange={(e) => setDados({...dados, endereco: e.target.value})} />
                                            <input type="text" className="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm text-gray-900 placeholder-gray-400" placeholder="Complemento" value={dados.complemento} onChange={(e) => setDados({...dados, complemento: e.target.value})} />
                                        </div>
                                    )}
                                </div>
                                <div className="pt-2">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">ESCOLHA DATA E HORA</label>
                                    <input type="date" min={hoje} className="w-full p-3 bg-white rounded-xl border border-gray-200 mb-3 font-bold text-gray-700" value={dados.data} onChange={(e) => { setDados({...dados, data: e.target.value, hora: ''}); verificarAgenda(e.target.value); }} />
                                    {dados.data && (
                                        <div className="grid grid-cols-4 gap-2 pb-2 mt-2">
                                            {carregandoHorarios ? <p className="col-span-4 text-center text-xs text-gray-400">Verificando agenda...</p> : 
                                            horariosDoDia.map((h) => {
                                                const isOcupado = horariosOcupados.includes(h);
                                                return (<button key={h} disabled={isOcupado} onClick={() => selecionarHorario(h)} className={`p-2 rounded text-xs font-bold border transition-all ${isOcupado ? 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed opacity-50' : dados.hora === h ? 'bg-pink-500 text-white border-pink-500 shadow-md transform scale-105' : 'bg-white text-gray-600 border-gray-200 hover:border-pink-300'}`}>{h}</button>)
                                            })}
                                        </div>
                                    )}
                                </div>
                                {dados.hora && (
                                    <div className="fade-in space-y-3 pt-2">
                                        <button 
                                            onClick={salvarEAvancar} 
                                            disabled={loadingSalvar}
                                            className={`w-full bg-gradient-to-r from-purple-600 to-purple-800 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 mt-2 flex items-center justify-center gap-2 ${loadingSalvar ? 'opacity-75 cursor-wait' : ''}`}
                                        >
                                            {loadingSalvar ? 'Processando...' : 'AGENDAR E ENVIAR ZAP'} <Icons.Whatsapp />
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    {/* MODAIS (Detalhes, Confirma√ß√£o, IA) */}
                    {modalDetalhes && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 fade-in" onClick={() => setModalDetalhes(null)}>
                            <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setModalDetalhes(null)} className="absolute top-3 right-3 bg-black/50 text-white rounded-full p-1 z-10"><Icons.Close /></button>
                                <div className="h-64 bg-gray-100"><img src={modalDetalhes.imagem} className="w-full h-full object-cover" /></div>
                                <div className="p-6">
                                    <h3 className="text-2xl font-bold text-gray-800 mb-2">{modalDetalhes.nome}</h3>
                                    <p className="text-gray-600 text-sm leading-relaxed mb-6 text-justify">{modalDetalhes.fullDesc || modalDetalhes.desc}</p>
                                    <button onClick={() => setModalDetalhes(null)} className="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200">Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {modalConfirmacao && (
                        <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 fade-in">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl border border-pink-100">
                                <div className="text-pink-500 text-3xl mb-3">‚è∞</div>
                                <h3 className="font-bold text-gray-800 mb-2">Confirmar Hor√°rio?</h3>
                                <p className="text-sm text-gray-500 mb-6">Voc√™ escolheu as <strong className="text-pink-500">{horarioPendente}</strong>.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setModalConfirmacao(false)} className="flex-1 py-3 rounded-xl text-xs font-bold text-gray-400 bg-gray-100">Voltar</button>
                                    <button onClick={confirmarHorario} className="flex-1 py-3 rounded-xl text-xs font-bold bg-pink-500 text-white">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showModalIA && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 fade-in" onClick={() => setShowModalIA(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-2">Consultora IA</h3>
                                <textarea className="w-full p-2 border rounded mb-2 text-sm" rows="3" placeholder="Ex: Quero algo natural..." value={inputIA} onChange={e => setInputIA(e.target.value)}></textarea>
                                <button onClick={consultarEstiloIA} disabled={loadingIA} className="w-full bg-purple-600 text-white py-2 rounded mb-2">{loadingIA ? '...' : 'Analisar'}</button>
                                {respostaIA && <p className="text-sm text-gray-600 bg-gray-50 p-2 rounded">{respostaIA.motivo}</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function TelaProfissional({ onSair }) {
            const [aba, setAba] = useState('confirma'); 
            const [dataLote, setDataLote] = useState(new Date().toISOString().split('T')[0]);
            const [listaClientes, setListaClientes] = useState([]);
            const [bancoClientes, setBancoClientes] = useState([]);
            const [loadingSync, setLoadingSync] = useState(false);
            const [loadingPlanilha, setLoadingPlanilha] = useState(false);
            const [despesas, setDespesas] = useState([]); 
            const [modalAnaliseIA, setModalAnaliseIA] = useState(null);
            const [analiseIA, setAnaliseIA] = useState(null);
            const [loadingMsgIA, setLoadingMsgIA] = useState(false);
            const [modalNiver, setModalNiver] = useState(null);
            const [temDesconto, setTemDesconto] = useState(false);
            const [valorDesconto, setValorDesconto] = useState(10);
            const [sugestaoIA, setSugestaoIA] = useState("");
            const [loadingIA, setLoadingIA] = useState(false);
            const [postIA, setPostIA] = useState({ servico: '', tom: 'Divertido', legenda: '' });

            useEffect(() => {
                const saved = localStorage.getItem('ls_despesas');
                if(saved) setDespesas(JSON.parse(saved));
                baixarClientesPlanilha();
            }, []);

            const sincronizarGoogleAgenda = async () => { 
                setLoadingSync(true); 
                const eventos = await fetchRawEvents(CONFIG.icalUrlPrivate, dataLote); 
                const listaFinal = eventos.map(ev => ({ 
                    id: Math.random(), 
                    nome: ev.summary || 'Cliente', 
                    hora: (ev.localHour < 10 ? '0'+ev.localHour : ev.localHour) + ":00", 
                    tipo: ev.location && ev.location.length > 5 ? 'domicilio' : 'studio',
                    whatsapp: ev.description ? ev.description.match(/Whats: ([\d() -]+)/)?.[1] : null
                }));
                setListaClientes(listaFinal);
                setLoadingSync(false); 
            };

            const baixarClientesPlanilha = async () => {
                setLoadingPlanilha(true);
                try {
                    const res = await fetch(`${CONFIG.scriptGoogleUrl}?action=readClients`);
                    const data = await res.json();
                    if (Array.isArray(data)) setBancoClientes(data);
                } catch (e) { console.error(e); }
                setLoadingPlanilha(false);
            };

            const abrirModalNiver = (cliente) => {
                setModalNiver(cliente);
                setTemDesconto(false);
                setSugestaoIA("");
                setLoadingIA(true);
                chamarGemini(`D√™ uma sugest√£o curta de desconto de anivers√°rio para a cliente ${cliente.nome}.`, "Especialista em Marketing").then(r => { setSugestaoIA(r); setLoadingIA(false); });
            };

            const enviarMensagemNiver = () => {
                if (!modalNiver) return;
                const msg = `Parab√©ns ${modalNiver.nome}! üéÇü•≥ Estamos enviando um presente especial de ${temDesconto ? valorDesconto + '% OFF' : 'uma surpresa'} para voc√™ real√ßar seu olhar! ü•∞`;
                window.open(`https://wa.me/55${modalNiver.zap.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
                setModalNiver(null);
            };

            const gerarAnaliseCliente = async (cliente) => {
                setLoadingMsgIA(true);
                setAnaliseIA(null);
                const resp = await chamarGemini(`Crie uma mensagem curta e profissional de fideliza√ß√£o para a cliente ${cliente.nome} que n√£o vem h√° alguns dias. Ofere√ßa um incentivo para retorno. Tom: Carinhoso e exclusivo.`, "Especialista em CRM");
                setAnaliseIA({ status: "Analisado", mensagem: resp, dica: "Ofere√ßa um mimo!" });
                setLoadingMsgIA(false);
            };

            const enviarMensagemAnalise = (zap, msg) => {
                const link = `https://wa.me/55${zap.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
                window.open(link, '_blank');
            };

            const gerarLegendaInstagram = async () => {
                setLoadingMsgIA(true);
                const prompt = `Crie uma legenda de Instagram para Lash Designers sobre ${postIA.servico} com tom ${postIA.tom}. Inclua emojis e hashtags.`;
                const resposta = await chamarGemini(prompt, "Copywriter de Redes Sociais");
                setPostIA({...postIA, legenda: resposta});
                setLoadingMsgIA(false);
            };
            
            const confirmarAgendamentoProfissional = (cliente) => {
                let zap = cliente.whatsapp;
                // Busca autom√°tica
                if (!zap) {
                    const clienteEncontrado = bancoClientes.find(c => c.nome.toLowerCase().includes(cliente.nome.toLowerCase()));
                    if (clienteEncontrado) zap = clienteEncontrado.zap;
                }
                
                if (zap) {
                    const msg = `Ol√° ${cliente.nome}! Passando para confirmar seu hor√°rio de C√≠lios amanh√£ √†s ${cliente.hora}. Tudo certo? ü•∞`;
                    window.open(`https://wa.me/55${zap.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
                } else {
                    const manualZap = prompt(`N√£o encontrei o WhatsApp de ${cliente.nome}. Digite o n√∫mero:`);
                    if(manualZap) {
                         const msg = `Ol√° ${cliente.nome}! Passando para confirmar seu hor√°rio de C√≠lios amanh√£ √†s ${cliente.hora}. Tudo certo? ü•∞`;
                         window.open(`https://wa.me/55${manualZap.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                }
            };
            
            const isAniversariante = (dataNasc) => {
                if (!dataNasc) return false;
                // Formato YYYY-MM-DD
                const parts = dataNasc.split('-');
                if(parts.length !== 3) return false;
                const hoje = new Date();
                return parseInt(parts[2]) === hoje.getDate() && parseInt(parts[1]) === (hoje.getMonth() + 1);
            };

            return (
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-purple-100 fade-in relative min-h-[600px] flex flex-col">
                    <button onClick={onSair} className="absolute top-4 right-4 text-white z-10"><Icons.LogOut /></button>
                    <div className="bg-purple-600 p-6 text-white">
                        <h2 className="text-xl font-bold">Painel da Le</h2>
                        <div className="flex gap-4 mt-4 text-[10px] font-bold overflow-x-auto no-scrollbar whitespace-nowrap">
                            {['confirma', 'financeiro', 'estrategia', 'clientes', 'marketing'].map(t => (
                                <button key={t} onClick={() => setAba(t)} className={`pb-1 border-b-2 uppercase ${aba === t ? 'border-white text-white' : 'border-transparent text-purple-300'}`}>{t}</button>
                            ))}
                        </div>
                    </div>
                    {aba === 'confirma' && (
                        <div className="p-4 flex-1 flex flex-col gap-4 fade-in">
                            <div className="bg-gray-50 p-4 rounded-xl border flex gap-2"><input type="date" className="flex-1 p-2 rounded-lg border text-sm" value={dataLote} onChange={e => setDataLote(e.target.value)} /><button onClick={sincronizarGoogleAgenda} className="bg-blue-600 text-white px-3 rounded-lg text-xs font-bold">{loadingSync ? '...' : <Icons.Refresh />}</button></div>
                            <div className="flex-1 overflow-y-auto space-y-2">
                                {listaClientes.map((c) => (<div key={c.id} className="p-3 rounded-xl border flex flex-col gap-2 bg-white"><div className="flex justify-between items-start"><div><p className="font-bold text-sm text-gray-800">{c.nome}</p><span className="bg-gray-100 text-xs px-1.5 rounded">{c.hora}</span></div></div><button onClick={() => confirmarAgendamentoProfissional(c)} className="w-full py-1 rounded-lg text-xs bg-green-500 text-white font-bold flex justify-center items-center gap-1"><Icons.Whatsapp /> Confirmar</button></div>))}
                            </div>
                        </div>
                    )}
                    {aba === 'financeiro' && <TelaFinanceiro listaClientes={listaClientes} despesas={despesas} setDespesas={setDespesas} />}
                    {aba === 'estrategia' && <TelaEstrategiaIA listaClientes={listaClientes} despesas={despesas} />}
                    {aba === 'clientes' && (
                        <div className="p-4 flex-1 flex flex-col gap-4 fade-in overflow-y-auto">
                            <button onClick={baixarClientesPlanilha} className="w-full bg-green-100 text-green-700 font-bold py-2 rounded-lg text-xs flex justify-center items-center gap-1"><Icons.Refresh /> Atualizar Lista</button>
                            {bancoClientes.map((c, i) => (
                                <div key={i} className="p-3 rounded-xl border mb-2 bg-white flex justify-between items-center">
                                    <div className="flex flex-col"><p className="font-bold text-sm text-gray-700">{c.nome}</p><p className="text-[10px] text-gray-400">{c.zap}</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setModalAnaliseIA(c); gerarAnaliseCliente(c); }} className="bg-purple-100 text-purple-600 py-1 px-2 rounded text-[10px] font-bold">Analisar</button>
                                        {isAniversariante(c.nascimento) && <button onClick={() => abrirModalNiver(c)} className="bg-pink-100 text-pink-600 py-1 px-2 rounded text-[10px] font-bold flex items-center gap-1"><Icons.Cake /> Parab√©ns</button>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {aba === 'marketing' && (
                        <div className="p-4 flex-1 flex flex-col gap-4 fade-in">
                            <div className="bg-pink-50 p-4 rounded-xl border border-pink-200">
                                <h3 className="font-bold text-pink-700 text-sm mb-3 flex items-center gap-2"><Icons.Gemini /> Gerador de Legenda</h3>
                                <select className="w-full p-2 mb-3 rounded border text-sm bg-white" value={postIA.servico} onChange={(e) => setPostIA({...postIA, servico: e.target.value})}><option value="">Servi√ßo...</option>{CONFIG.servicos.map(s => <option key={s.id} value={s.nome}>{s.nome}</option>)}</select>
                                <select className="w-full p-2 mb-3 rounded border text-sm bg-white" value={postIA.tom} onChange={(e) => setPostIA({...postIA, tom: e.target.value})}><option value="Divertido">Divertido</option><option value="Profissional">Profissional</option></select>
                                <button onClick={gerarLegendaInstagram} disabled={loadingMsgIA || !postIA.servico} className="w-full bg-pink-500 text-white font-bold py-2 rounded-lg text-sm hover:bg-pink-600 disabled:opacity-50">{loadingMsgIA ? '...' : '‚ú® Criar'}</button>
                            </div>
                            {postIA.legenda && <textarea className="w-full h-32 p-2 bg-gray-50 rounded border text-sm" value={postIA.legenda} readOnly></textarea>}
                        </div>
                    )}
                    
                    {modalNiver && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 fade-in">
                            <div className="bg-white rounded-3xl w-full max-w-md overflow-hidden relative transform scale-100 transition-all shadow-2xl">
                                <div className="modal-gradient p-8 text-center flex flex-col items-center justify-center relative">
                                    <button onClick={()=>setModalNiver(null)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800 bg-white/50 rounded-full p-1"><Icons.Close /></button>
                                    <div className="text-7xl mb-4 animate-bounce filter drop-shadow-md">üéÇ</div>
                                    <h3 className="font-bold text-3xl text-purple-800 mb-2">Parab√©ns, {modalNiver.nome.split(' ')[0]}!</h3>
                                    <p className="text-purple-600 text-base mb-8 font-medium">Vamos mimar essa cliente especial?</p>
                                    
                                    <div className="w-full space-y-4">
                                        <div className="flex gap-3 justify-center">
                                            <button onClick={()=>setTemDesconto(true)} className={`flex-1 py-4 rounded-2xl text-sm font-bold border-2 shadow-sm transition-all transform hover:-translate-y-1 ${temDesconto?'bg-pink-50 text-pink-600 border-pink-400':'bg-white text-gray-500 border-gray-200'}`}>Sim, Desconto üéÅ</button>
                                            <button onClick={()=>setTemDesconto(false)} className={`flex-1 py-4 rounded-2xl text-sm font-bold border-2 shadow-sm transition-all transform hover:-translate-y-1 ${!temDesconto?'bg-white text-gray-600 border-gray-300':'bg-white text-gray-400 border-gray-100'}`}>S√≥ Mensagem üíå</button>
                                        </div>
                                        
                                        {temDesconto && (
                                            <div className="fade-in flex items-center justify-center gap-3 bg-white/80 p-3 rounded-2xl border border-pink-200 shadow-inner">
                                                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Desconto:</span>
                                                <input type="number" className="w-24 p-2 border-b-2 border-pink-300 text-center font-bold text-pink-600 text-2xl focus:outline-none bg-transparent" value={valorDesconto} onChange={e=>setValorDesconto(e.target.value)} />
                                                <span className="text-2xl font-bold text-pink-400">%</span>
                                            </div>
                                        )}
                                        
                                        <button onClick={enviarMensagemNiver} className="w-full py-4 bg-[#25D366] hover:bg-[#1ebd59] text-white rounded-2xl font-bold shadow-lg flex justify-center items-center gap-3 transition-all transform hover:scale-105 active:scale-95 text-lg mt-4">
                                            <Icons.Whatsapp /> Enviar Mensagem Agora
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Analise IA */}
                    {modalAnaliseIA && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 fade-in" onClick={() => setModalAnaliseIA(null)}>
                            <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden relative" onClick={e => e.stopPropagation()}>
                                <div className="bg-gradient-to-r from-purple-600 to-pink-500 p-4 text-white font-bold flex justify-between items-center">
                                    <h3 className="flex gap-2 items-center"><Icons.Analysis /> An√°lise de {modalAnaliseIA.nome}</h3>
                                    <button onClick={()=>setModalAnaliseIA(null)}><Icons.Close /></button>
                                </div>
                                <div className="p-5 space-y-4">
                                    {loadingMsgIA ? <div className="text-center text-purple-600 py-4"><div className="loader mx-auto"></div></div> : analiseIA ? (
                                        <>
                                            <div className="bg-purple-50 p-3 rounded-lg border border-purple-100"><p className="text-sm font-bold text-purple-700">{analiseIA.status}</p></div>
                                            <p className="text-xs font-bold text-gray-400 uppercase">Mensagem Sugerida:</p>
                                            <textarea className="w-full h-32 p-3 border rounded-lg text-sm bg-gray-50" value={analiseIA.mensagem} readOnly></textarea>
                                            <button onClick={() => enviarMensagemAnalise(modalAnaliseIA.zap, analiseIA.mensagem)} className="w-full mt-2 bg-green-500 text-white py-3 rounded-xl text-xs font-bold hover:bg-green-600 flex justify-center gap-2 shadow-md">Enviar Agora <Icons.Whatsapp /></button>
                                        </>
                                    ) : <p className="text-center text-gray-500 text-sm">Erro na an√°lise.</p>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL (APP) ---
        function App() {
            const [tela, setTela] = useState('cliente');
            const [dadosFinal, setDadosFinal] = useState(null);

            const handleSucesso = (dados) => {
                setDadosFinal(dados);
                setTela('sucesso');
            };

            const irWhatsapp = () => {
                if(!dadosFinal) return;
                const msg = `Ol√°! Agendei pelo site: ${dadosFinal.servicoObj.nome} - Dia ${dadosFinal.data.split('-').reverse().join('/')} √†s ${dadosFinal.hora}. Nome: ${dadosFinal.nome}`;
                window.open(`https://wa.me/${CONFIG.telefoneProfissional}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            return (
                <div className="min-h-screen bg-pink-50 p-4 font-sans flex flex-col items-center">
                    <div className="w-full max-w-md mb-4 text-center">
                        <img src="img/logo.png" alt="Logo" className="w-40 h-auto mb-2 object-contain mx-auto" onError={(e) => { e.target.style.display = 'none'; }} />
                        <h1 className="text-2xl font-bold text-gray-800">Ls <span className="text-pink-600">C√≠lios</span></h1>
                    </div>

                    {tela === 'sucesso' && (
                        <div className="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-6 animate-in">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-4xl text-green-500 mb-4 animate-bounce">‚úì</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Agendado! üéâ</h2>
                            <p className="text-center text-gray-600 text-sm mb-8">Seu hor√°rio est√° pr√©-reservado. Envie a mensagem para confirmar.</p>
                            <button onClick={irWhatsapp} className="w-full max-w-xs bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-green-600 transition-all">
                                <Icons.Whatsapp /> Enviar no WhatsApp
                            </button>
                            <button onClick={() => window.location.reload()} className="mt-6 text-gray-400 text-xs underline">Voltar ao in√≠cio</button>
                        </div>
                    )}

                    {tela === 'cliente' && (
                        <div className="w-full max-w-md">
                            <TelaCliente aoFinalizar={handleSucesso} verificarDisponibilidade={async ()=>{}} horariosOcupados={[]} carregandoHorarios={false} horariosDoDia={[]} />
                        </div>
                    )}
                    
                    {tela === 'login' && <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-purple-100"><TelaLogin onLogin={() => setTela('profissional')} /></div>}
                    
                    {tela === 'profissional' && <TelaProfissional onSair={() => setTela('cliente')} />}
                    
                    {tela !== 'login' && tela !== 'profissional' && tela !== 'sucesso' && (
                        <div className="mt-8 text-center"><button onClick={() => setTela('login')} className="text-xs text-gray-300 flex items-center justify-center gap-1 mx-auto"><Icons.Lock /> √Årea Profissional</button></div>
                    )}
                    <ChatbotIA />
                </div>
            );
        }

        // --- COMPONENTE LOGIN (RESTAURADO) ---
        function TelaLogin({ onLogin }) {
            const [pass, setPass] = useState('');
            const [erro, setErro] = useState(false);
            const tentarLogin = () => { if(pass === CONFIG.senhaAdmin) { onLogin(); } else { setErro(true); } };
            return (
                <div className="flex items-center justify-center min-h-[300px] p-8 fade-in">
                    <div className="w-full max-w-xs text-center">
                        <div className="mb-4 text-purple-600 text-5xl"><Icons.Lock /></div>
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Acesso Restrito</h2>
                        <input type="password" placeholder="Senha" className="w-full p-3 border rounded-xl mb-3 text-center" value={pass} onChange={e => {setPass(e.target.value); setErro(false);}} />
                        {erro && <p className="text-red-500 text-xs font-bold mb-3">Senha incorreta!</p>}
                        <button onClick={tentarLogin} className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700">Entrar</button>
                        <button onClick={() => window.location.reload()} className="mt-4 text-xs text-gray-400 hover:text-gray-600">Voltar</button>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
